# netmon

Сервис базового мониторинга сетей блокчейна **WAVES** (mainnet, stagenet, testnet). Сервис хранит все данные в
оперативной памяти не имеет постоянного хранилища, вследствие чего после перезапуска сервис теряет все накопленные
статистики и оценки.

## Command line parameters

Далее будут описаны параметры, которые можно передать исполняемому файлу при запуске для изменения его поведения по
умолчанию. Также, с помощью переменных окружения можно переопределять параметры по умолчанию.

### Basic command line parameters

Базовые настройки:

- _--log-level_ - уровень логирования. Поддерживаемые уровни:  _DEV_, _DEBUG_, _INFO_, _WARN_, _ERROR_, _FATAL_. По
  умолчанию _INFO_. Переменная окружения: _LOG_LEVEL_.
- _--bind-addr_ - IP адрес и порт, на котором будет запущен сервис. По умолчанию _0.0.0.0:2048_. Переменная окружения:
  _BIND_ADDR_.
- _--network-scheme_ - байт сети WAVES, за которой будет наблюдать сервис. Поддерживаемые сети: _W_ (mainnet),
  _T_ (testnet), _S_ (stagenet), _E_ (custom). По умолчанию _W_. Переменная окружения: _NETWORK_SCHEME_.
- _--stats-url_ - URL, с которого будет собираться статистика по узлам сети. По
  умолчанию _https://waves-nodes-get-height.wavesnodes.com/_. Переменная окружения: _STATS_URL_.
- _--stats-poll-interval_ - интервал сбора, через который будет собираться статистика по узлам сети и обновляться
  статистики. По умолчанию _1m_. Переменная окружения: _STATS_POLL_INTERVAL_.
- _--max-poll-response-size_ - максимальный размер ответа в байтах по URL сбора статистик. По умолчанию: _131072_.
  Переменная окружения: _MAX_POLL_RESPONSE_SIZE_.
- _--stats-history-size_ - количество последних хранимых снимков статистик. Должен быть больше 0. По умолчанию _10_.
  Переменная окружения: _STATS_HISTORY_SIZE_.
- _--network-errors-streak_ - число последовательных ошибок, после будет считаться, что сеть находится в деградированном
  состоянии. По умолчанию _5_. Переменная окружения: _NETWORK_ERRORS_STREAK_.
- _--initial-mon-state_ - состояние мониторинга при старте. Возможные значения: _active_, _frozen_operates_stable_,
  _frozen_degraded_. По умолчанию _active_. Переменная окружения: _INITIAL_MON_STATE_.
- _--http-auth-header_ - HTTP заголовок, в котором будет проверяться наличие токена для доступа к приватным URL. По
  умолчанию _X-Waves-Monitor-Auth_. Переменная окружения: _HTTP_AUTH_HEADER_.
- _--http-auth-token_ - токен доступа к приватным URL. **ОБЯЗАТЕЛЬНЫЙ** параметр. Значение по умолчанию отсутствует.
  Переменная окружения: _HTTP_AUTH_TOKEN_.

## Monitoring criteria

Далее будут описаны опции (критерии), которые непосредственно влияют на мониторинг ошибок. Состояние сети будет
оцениваться по серии *последовательных* ошибок, которые генерирует сервис. При генерации ошибки будет увеличиваться
счётчик последовательных ошибок, однако если после серии ошибок произойдёт сбор статистик и их оценка, в результате
которой ошибка *не* будет сгенерирована, то счётчик последовательности ошибок сбросится.

#### Down nodes criterion

- _--criterion-down-total-part_ - пороговое значение при достижении которого будет генерироваться ошибка. Считается как
  отношение недоступных узлов ко всем отслеживаемым узлам. Диапазон значений: от _0.0_ не включительно до _1.0_
  включительно. По умолчанию _0.3_. Переменная окружения: _CRITERION_DOWN_TOTAL_PART_.

#### Nodes height criterion

- _--criterion-height-diff_ - разница высот узлов сети при достижении которой будет генерироваться ошибка. По
  умолчанию _10_ блоков. Переменная окружения: _CRITERION_HEIGHT_DIFF_.
- _--criterion-height-require-min-nodes-on-same-height_ - необходимое количество узлов сети, которые находятся на одной
  высоте. По умолчанию _2_ узла. Переменная окружения: _CRITERION_HEIGHT_REQUIRE_MIN_NODES_ON_SAME_HEIGHT_.

#### Statehash criterion

Здесь под группой понимается группа узлов сети на одной высоте, узлы которой имеют одинаковые стейтхеши.

- _--criterion-statehash-min-groups-on-same-height_ - минимальное количество групп узлов сети с разными стейтхешами на
  одной высоте. По умолчанию _2_ группы. Переменная окружения: _CRITERION_STATEHASH_MIN_GROUPS_ON_SAME_HEIGHT_.
- _--criterion-statehash-min-valuable-groups_ - минимальное значение _значащих_ групп узлов на одной высоте. По
  умолчанию _2_ группы. Переменная окружения: _CRITERION_STATEHASH_MIN_VALUABLE_GROUPS_.
- _--criterion-statehash-min-nodes-in-valuable-group_ - минимальное количество узлов сети в группе. Если группа узлов с
  одинаковыми стейтхешами имеет данное и более количество узлов, то она считается _значащей_. По умолчанию _2_ узла.
  Переменная окружения: _CRITERION_STATEHASH_MIN_NODES_IN_VALUABLE_GROUP_.
- _--criterion-statehash-require-min-nodes-on-same-height_ - необходимое количество узлов сети, которые находятся на
  одной высоте. По умолчанию _4_ узла. Переменная окружения: _CRITERION_STATEHASH_REQUIRE_MIN_NODES_ON_SAME_HEIGHT_.

## HTTP API

### Public URLs

1) **GET** _/health_ - возвращает байт отслеживаемой сети, текущее состояние сети, максимальную высоту и время
   последнего обновления статистик. Если высоту не удалось получить хотя бы с одного узла, который участвует в
   мониторинге, то вместо высоты будет отдано _-1_.

    - Возможные HTTP коды ответа:
        - _200 OK_
        - _405 Method Not Allowed_
        - _500 Internal Server Error_
    - Возвращаемый результат:
        - `{"updated":"2021-12-02T19:35:24.144994Z","network":"W","status":true,"height":2882018}` - сеть в порядке
        - `{"updated":"2021-12-02T19:35:24.144994Z","network":"W","status":false,"height":2882018}` - сеть в
          деградированном состоянии, но если хотя бы один узел доступен
        - `{"updated":"2021-12-02T19:35:24.144994Z","network":"W","status":false,"height":-1}` - сеть в деградированном
          состоянии и все узлы недоступны
    - Пример запроса: `curl http://localhost:2048/health`

### Private URLs

1) **POST** _/state_ - устанавливает состояние мониторинга. В случае, если новое состояние отличается от старого, то
   установка нового состояния сбрасывает счётчик последовательности ошибок.

    - Возможные HTTP коды ответа:
        - _200 OK_
        - _400 Bad Request_
        - _403 Forbidden_
        - _405 Method Not Allowed_
        - _500 Internal Server Error_
    - Возвращаемый результат: отсутствует
    - Возможные значения тела запроса:
        - `{"state":"active"}` - установка мониторинга в обычный (активный) режим работы
        - `{"state":"frozen_operates_stable"}` - установка мониторинга в режим, при котором он всегда будет отвечать на
          запрос **GET** _/health_ ответом  `{"status":true}`
        - `{"state":"frozen_degraded"}` - установка мониторинга в режим, при котором он всегда будет отвечать на
          запрос **GET** _/health_ ответом  `{"status":false}`
    - Пример
      запроса: `curl -X POST -H "Content-Type: application/json" -d '{"state":"active"}' http://localhost:2048/state`

## Build

Требования: на машине должны быть установлены утилита `Make`, компилятор и стандартная библиотека языка `Go`. Собрать
исполняемый файл можно командой `make build`. Исполняемый файл после сборки будет внутри директории `build`.

## Docker

Сборка проекта происходит при значении переменной окружения `CGO_ENABLED=0`, соответственно исполняемый файл сервиса не
требует динамически подключаемых библиотек и содержит в себе все необходимые зависимости для работы.

Сервис мониторинга внутри контейнер запускается от имени пользователя _netmon_. Часовая зона внутри контейнера
установлена в значение _Etc/UTC_.

Аргументы мониторинга можно пробросить внутрь контейнера просто добавив эти аргументы в конец команды запуска
контейнера. Пример:

```shell
$ docker build -t netmon -f Dockerfile . # build container
$ docker run --rm -ti --name netmon -p 2048:2048 netmon --http-auth-token="your-token" # run and pass CLI arguments
```
